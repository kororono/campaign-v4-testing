<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campaign Transparency Initiative - Live</title>
    <!-- Tailwind CSS for modern, utility-first styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for better typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="pattern-bg">
    <!-- (everything else remains unchanged) -->

    <script>
        // ... (other functions stay the same)

        /**
         * Verifies a contribution based on user input.
         * @param {Event} event - The form submission event.
         */
        async function verifyContribution(event) {
            event.preventDefault();
            const date = document.getElementById('date').value;
            const time = document.getElementById('time').value;
            const amount = document.getElementById('amount').value;
            const resultEl = document.getElementById("verifyResult");

            if (!date || !time || !amount) {
                resultEl.innerHTML = `<p class="text-yellow-600 font-semibold">Please fill in all fields to verify.</p>`;
                return;
            }

            resultEl.innerHTML = `<div class="loading-spinner h-12 w-12 mx-auto"></div>`;

            try {
                const res = await fetch(API_URL + '?method=GET');
                if (!res.ok) throw new Error('Network response was not ok.');
                const data = await res.json();

                let processedData = [];
                if (Array.isArray(data)) {
                    processedData = data;
                } else if (data.data && Array.isArray(data.data)) {
                    processedData = data.data;
                } else if (data.values && Array.isArray(data.values)) {
                    processedData = data.values;
                }

                const matchedTransaction = processedData.find(row => {
                    if (!row.date || !row.time || !row.amount) return false;

                    const isDateMatch = row.date === date;
                    const isAmountMatch = parseFloat(row.amount) === parseFloat(amount);
                    const inputTime = new Date(`1970-01-01T${time}:00`);
                    const transactionTime = new Date(`1970-01-01T${row.time}`);
                    const timeDiffHours = Math.abs(inputTime - transactionTime) / 3600000;
                    const isTimeMatch = timeDiffHours <= 1;

                    return isDateMatch && isAmountMatch && isTimeMatch;
                });

                setTimeout(() => {
                    if (matchedTransaction) {
                        const isOnChain = matchedTransaction.onChain?.toString().toLowerCase() === 'true';
                        const txHash = matchedTransaction.blockchainTxHash || matchedTransaction.txHash;

                        if (isOnChain && txHash && txHash !== 'undefined' && txHash !== '') {
                            resultEl.innerHTML = `
                                <div class="bg-green-100 text-green-800 p-4 rounded-lg transition-all duration-300">
                                    <p class="font-bold text-lg">✅ Verified On-Chain!</p>
                                    <p class="text-sm mt-2">Your transaction is confirmed on the Sepolia blockchain.</p>
                                    <div class="mt-4 p-4 bg-white rounded-lg border border-green-200">
                                        <p class="font-semibold text-sm mb-2">Blockchain Transaction Hash:</p>
                                        <div class="flex items-center gap-2 mb-3">
                                            <code class="bg-gray-100 px-2 py-1 rounded text-xs font-mono break-all flex-1">${txHash}</code>
                                            <button onclick="copyToClipboard('${txHash}')" 
                                                    class="text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600 transition-colors">
                                                Copy
                                            </button>
                                        </div>
                                        <div class="flex gap-2">
                                            <a href="https://sepolia.etherscan.io/tx/${txHash}" 
                                               target="_blank" 
                                               class="inline-flex items-center gap-1 text-blue-600 hover:text-blue-800 text-sm font-medium transition-colors">
                                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                                </svg>
                                                View on Etherscan
                                            </a>
                                            <a href="https://sepolia.basescan.org/tx/${txHash}" 
                                               target="_blank" 
                                               class="inline-flex items-center gap-1 text-purple-600 hover:text-purple-800 text-sm font-medium transition-colors">
                                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                                </svg>
                                                View on Basescan
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else if (isOnChain) {
                            resultEl.innerHTML = `
                                <div class="bg-yellow-100 text-yellow-800 p-4 rounded-lg transition-all duration-300">
                                    <p class="font-bold text-lg">⚠️ On-Chain, Hash Processing</p>
                                    <p class="text-sm mt-1">Your transaction is confirmed on-chain but the blockchain hash is still being processed. Please check back in a few minutes.</p>
                                </div>
                            `;
                        } else {
                            resultEl.innerHTML = `
                                <div class="bg-yellow-100 text-yellow-800 p-4 rounded-lg transition-all duration-300">
                                    <p class="font-bold text-lg">⚠️ Transaction Found, Pending Blockchain</p>
                                    <p class="text-sm mt-1">Your transaction has been recorded but is still pending blockchain confirmation.</p>
                                </div>
                            `;
                        }
                    } else {
                        resultEl.innerHTML = `
                            <div class="bg-red-100 text-red-800 p-4 rounded-lg transition-all duration-300">
                                <p class="font-bold text-lg">❌ No Matching Transaction Found</p>
                                <p class="text-sm mt-1">Please double-check the date, time, and amount. New transactions may take a few minutes to appear in our system.</p>
                            </div>
                        `;
                    }
                }, 500);

            } catch (err) {
                console.error("Verification failed:", err);
                resultEl.innerHTML = `
                    <div class="bg-red-100 text-red-800 p-4 rounded-lg">
                        <p class="font-bold text-lg">Error</p>
                        <p class="text-sm mt-1">Could not complete verification. Please try again later.</p>
                    </div>
                `;
            }
        }

        // --- Copy to clipboard helper ---
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                const event = new CustomEvent('show-toast', {
                    detail: { message: 'Transaction hash copied to clipboard!', type: 'success' }
                });
                document.dispatchEvent(event);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
            });
        }
    </script>
</body>
</html>
